#include "filters.h"
 
// Lowpass filter for ADXL345 accelerometer 
arm_fir_decimate_instance_f32 accel_lpf[3];
float accel_lpf_state[3][ACCEL_FILTER_SIZE + ACCEL_DECIMATION - 1];
float accel_lpf_coeffs[ACCEL_FILTER_SIZE] = {-0.000971251596459908, -7.69406717604047e-05, -6.19799209654469e-05, -3.30906543649738e-05, 1.10814561797306e-05, 7.24805531343648e-05, 0.000152598071257586, 0.000253698805736882, 0.000377317468335945, 0.000525701202486072, 0.000700518195310734, 0.000903997339458505, 0.00113739692160716, 0.00140312152077752, 0.00170195103075679, 0.00203566452362004, 0.00240546060485815, 0.00281231733030840, 0.00325638090562598, 0.00373853563596467, 0.00425842477132322, 0.00481595944431221, 0.00541027647136111, 0.00604061130952030, 0.00670524975565512, 0.00740308239924367, 0.00813154544121787, 0.00888873230285860, 0.00967096533068780, 0.0104756034830591, 0.0112971993347504, 0.0121352733530491, 0.0129849453923593, 0.0138385519287171, 0.0146955841292333, 0.0155486053454725, 0.0163942550438339, 0.0172263771763229, 0.0180408483356263, 0.0188316697226914, 0.0195946307655523, 0.0203241247156848, 0.0210158009852968, 0.0216645459211678, 0.0222667388005664, 0.0228165591799628, 0.0233122609941272, 0.0237489436996918, 0.0241240737240030, 0.0244343475043236, 0.0246784705527375, 0.0248538046118870, 0.0249598963537244, 0.0249951385161779, 0.0249598963537244, 0.0248538046118870, 0.0246784705527375, 0.0244343475043236, 0.0241240737240030, 0.0237489436996918, 0.0233122609941272, 0.0228165591799628, 0.0222667388005664, 0.0216645459211678, 0.0210158009852968, 0.0203241247156848, 0.0195946307655523, 0.0188316697226914, 0.0180408483356263, 0.0172263771763229, 0.0163942550438339, 0.0155486053454725, 0.0146955841292333, 0.0138385519287171, 0.0129849453923593, 0.0121352733530491, 0.0112971993347504, 0.0104756034830591, 0.00967096533068780, 0.00888873230285860, 0.00813154544121787, 0.00740308239924367, 0.00670524975565512, 0.00604061130952030, 0.00541027647136111, 0.00481595944431221, 0.00425842477132322, 0.00373853563596467, 0.00325638090562598, 0.00281231733030840, 0.00240546060485815, 0.00203566452362004, 0.00170195103075679, 0.00140312152077752, 0.00113739692160716, 0.000903997339458505, 0.000700518195310734, 0.000525701202486072, 0.000377317468335945, 0.000253698805736882, 0.000152598071257586, 7.24805531343648e-05, 1.10814561797306e-05, -3.30906543649738e-05, -6.19799209654469e-05, -7.69406717604047e-05, -0.000971251596459908};;
float accel_history[3][2*ACCEL_FILTER_SIZE];
uint8_t accel_history_index = 0;
uint8_t accel_history_filter_index = 0;
float filtered_a[3];
    
    
// Lowpass filter for ADXRS453 ars
arm_fir_decimate_instance_f32 adxrs453_lpf;
float adxrs453_lpf_state[ADXRS453_FILTER_SIZE + ADXRS453_DECIMATION - 1];
float adxrs453_lpf_coeffs[ADXRS453_FILTER_SIZE] = {0.000765996615305244, 0.000660820151020175, 0.000904398442903659, 0.00116993648900164, 0.00144225289999618, 0.00170146983193675, 0.00192506416920931, 0.00208637960406920, 0.00215549334724139, 0.00210628189455340, 0.00190929130872978, 0.00154175764366672, 0.000985379572064331, 0.000231037660150656, -0.000720975242728358, -0.00185800385190914, -0.00315400290658119, -0.00456986885279512, -0.00605129658439567, -0.00753137446367871, -0.00893102356144855, -0.0101624543586776, -0.0111314200131555, -0.0117417714988076, -0.0118994911274908, -0.0115170351071913, -0.0105188708579065, -0.00884554022866118, -0.00645838490726134, -0.00334261386423469, 0.000489473606544453, 0.00499731904300335, 0.0101115226151986, 0.0157346375919648, 0.0217436975271735, 0.0279935671243145, 0.0343218642376052, 0.0405544117337099, 0.0465120006171619, 0.0520171194154150, 0.0569010809190037, 0.0610109684009580, 0.0642158515277905, 0.0664123296154894, 0.0675288324909505, 0.0675288324909505, 0.0664123296154894, 0.0642158515277905, 0.0610109684009580, 0.0569010809190037, 0.0520171194154150, 0.0465120006171619, 0.0405544117337099, 0.0343218642376052, 0.0279935671243145, 0.0217436975271735, 0.0157346375919648, 0.0101115226151986, 0.00499731904300335, 0.000489473606544453, -0.00334261386423469, -0.00645838490726134, -0.00884554022866118, -0.0105188708579065, -0.0115170351071913, -0.0118994911274908, -0.0117417714988076, -0.0111314200131555, -0.0101624543586776, -0.00893102356144855, -0.00753137446367871, -0.00605129658439567, -0.00456986885279512, -0.00315400290658119, -0.00185800385190914, -0.000720975242728358, 0.000231037660150656, 0.000985379572064331, 0.00154175764366672, 0.00190929130872978, 0.00210628189455340, 0.00215549334724139, 0.00208637960406920, 0.00192506416920931, 0.00170146983193675, 0.00144225289999618, 0.00116993648900164, 0.000904398442903659, 0.000660820151020175, 0.000765996615305244};;
float adxrs453_history[2*ADXRS453_FILTER_SIZE];
uint8_t adxrs453_history_index = 0;
uint8_t adxrs453_history_filter_index = 0;
float filtered_arz;
    
    
// Lowpass filter for ADXRS290 ars's
arm_fir_decimate_instance_f32 adxrs290_lpf[2];
float adxrs290_lpf_state[2][ADXRS290_FILTER_SIZE + ADXRS290_DECIMATION - 1];
float adxrs290_lpf_coeffs[] = {0.00501118553802371, -0.00179841043427587, -0.00154684600420296, -0.00135734630748630, -0.00121872872114182, -0.00111846416257322, -0.00105052487924695, -0.00100636633578688, -0.000982847879640758, -0.000973849382717162, -0.000978462514467537, -0.000991863198578358, -0.00101419829297811, -0.00104169792030007, -0.00107517489232123, -0.00111139193177223, -0.00115198176354170, -0.00119361816905439, -0.00123829569201916, -0.00128299521747977, -0.00132998963817954, -0.00137622200418264, -0.00142427720129490, -0.00147075904533267, -0.00151859782636166, -0.00156439817510545, -0.00161138025578111, -0.00165551551617682, -0.00170083320699632, -0.00174244097433984, -0.00178558076731861, -0.00182397908065468, -0.00186494854278862, -0.00189820374362171, -0.00193750008475035, -0.00196674745529890, -0.00199432554654777, -0.00203146762214601, -0.00204955344088376, -0.00207081343978643, -0.00209121732041240, -0.00211141840554774, -0.00212380057200789, -0.00213233241811395, -0.00213620532304049, -0.00213921885006130, -0.00213888473808765, -0.00213544769212604, -0.00212630466558039, -0.00211263424716890, -0.00209332397207618, -0.00207018596120179, -0.00204264535568655, -0.00201124791055918, -0.00197529024444520, -0.00193476094864309, -0.00188879109919071, -0.00183741608634591, -0.00178023078478873, -0.00171751249581575, -0.00164933968335390, -0.00157606112770736, -0.00149748462717980, -0.00141364312730730, -0.00132453918922693, -0.00122982368338853, -0.00112972059287131, -0.00102340115699917, -0.000911886629182845, -0.000792780192568898, -0.000670889916364104, -0.000539430126082152, -0.000405123195378110, -0.000265389593550935, -0.000117689691251144, 3.35884324158542e-05, 0.000189614496775903, 0.000351468916051090, 0.000519603490829468, 0.000692266621626914, 0.000869743817020208, 0.00105199380777776, 0.00123999791685492, 0.00143325212411582, 0.00163114035967737, 0.00183275341987610, 0.00203894940204918, 0.00224916590377688, 0.00246399384923279, 0.00268279714509845, 0.00290503189899027, 0.00313040427863598, 0.00335881602950394, 0.00359022105112672, 0.00382454227656126, 0.00406152429059148, 0.00430088536813855, 0.00454221712425351, 0.00478552421554923, 0.00503016449511051, 0.00527625484392047, 0.00552326347678900, 0.00577158993110061, 0.00602038111537695, 0.00626991409808397, 0.00651950109750032, 0.00676779868081212, 0.00701727718114853, 0.00726404832676053, 0.00751061458140612, 0.00775588583201170, 0.00799916964024305, 0.00824034679681063, 0.00848015490919352, 0.00871717743575573, 0.00895121414214373, 0.00918190274387598, 0.00940938573330641, 0.00963314250111580, 0.00985319912433624, 0.0100684780627489, 0.0102794291451573, 0.0104862460866570, 0.0106878373771906, 0.0108843445777893, 0.0110750822350383, 0.0112599348649383, 0.0114390701055527, 0.0116119431331754, 0.0117783918976784, 0.0119377626106143, 0.0120902946218848, 0.0122356330975890, 0.0123740844428539, 0.0125051895156503, 0.0126287108287215, 0.0127443587407470, 0.0128520121797919, 0.0129517428576946, 0.0130429118871689, 0.0131260985508561, 0.0132003771141171, 0.0132662327960134, 0.0133242271840572, 0.0133725376799703, 0.0134126702323556, 0.0134436674416065, 0.0134659400209785, 0.0134792160242796, 0.0134839843958616, 0.0134792160242796, 0.0134659400209785, 0.0134436674416065, 0.0134126702323556, 0.0133725376799703, 0.0133242271840572, 0.0132662327960134, 0.0132003771141171, 0.0131260985508561, 0.0130429118871689, 0.0129517428576946, 0.0128520121797919, 0.0127443587407470, 0.0126287108287215, 0.0125051895156503, 0.0123740844428539, 0.0122356330975890, 0.0120902946218848, 0.0119377626106143, 0.0117783918976784, 0.0116119431331754, 0.0114390701055527, 0.0112599348649383, 0.0110750822350383, 0.0108843445777893, 0.0106878373771906, 0.0104862460866570, 0.0102794291451573, 0.0100684780627489, 0.00985319912433624, 0.00963314250111580, 0.00940938573330641, 0.00918190274387598, 0.00895121414214373, 0.00871717743575573, 0.00848015490919352, 0.00824034679681063, 0.00799916964024305, 0.00775588583201170, 0.00751061458140612, 0.00726404832676053, 0.00701727718114853, 0.00676779868081212, 0.00651950109750032, 0.00626991409808397, 0.00602038111537695, 0.00577158993110061, 0.00552326347678900, 0.00527625484392047, 0.00503016449511051, 0.00478552421554923, 0.00454221712425351, 0.00430088536813855, 0.00406152429059148, 0.00382454227656126, 0.00359022105112672, 0.00335881602950394, 0.00313040427863598, 0.00290503189899027, 0.00268279714509845, 0.00246399384923279, 0.00224916590377688, 0.00203894940204918, 0.00183275341987610, 0.00163114035967737, 0.00143325212411582, 0.00123999791685492, 0.00105199380777776, 0.000869743817020208, 0.000692266621626914, 0.000519603490829468, 0.000351468916051090, 0.000189614496775903, 3.35884324158542e-05, -0.000117689691251144, -0.000265389593550935, -0.000405123195378110, -0.000539430126082152, -0.000670889916364104, -0.000792780192568898, -0.000911886629182845, -0.00102340115699917, -0.00112972059287131, -0.00122982368338853, -0.00132453918922693, -0.00141364312730730, -0.00149748462717980, -0.00157606112770736, -0.00164933968335390, -0.00171751249581575, -0.00178023078478873, -0.00183741608634591, -0.00188879109919071, -0.00193476094864309, -0.00197529024444520, -0.00201124791055918, -0.00204264535568655, -0.00207018596120179, -0.00209332397207618, -0.00211263424716890, -0.00212630466558039, -0.00213544769212604, -0.00213888473808765, -0.00213921885006130, -0.00213620532304049, -0.00213233241811395, -0.00212380057200789, -0.00211141840554774, -0.00209121732041240, -0.00207081343978643, -0.00204955344088376, -0.00203146762214601, -0.00199432554654777, -0.00196674745529890, -0.00193750008475035, -0.00189820374362171, -0.00186494854278862, -0.00182397908065468, -0.00178558076731861, -0.00174244097433984, -0.00170083320699632, -0.00165551551617682, -0.00161138025578111, -0.00156439817510545, -0.00151859782636166, -0.00147075904533267, -0.00142427720129490, -0.00137622200418264, -0.00132998963817954, -0.00128299521747977, -0.00123829569201916, -0.00119361816905439, -0.00115198176354170, -0.00111139193177223, -0.00107517489232123, -0.00104169792030007, -0.00101419829297811, -0.000991863198578358, -0.000978462514467537, -0.000973849382717162, -0.000982847879640758, -0.00100636633578688, -0.00105052487924695, -0.00111846416257322, -0.00121872872114182, -0.00135734630748630, -0.00154684600420296, -0.00179841043427587, 0.00501118553802371};    
float adxrs290_history[2][2*ADXRS290_FILTER_SIZE];
uint16_t adxrs290_history_index = 0;
uint16_t adxrs290_history_filter_index = 0;
float filtered_ar[2];    

uint8_t adxrs290_lowpass_ready = 0;
uint8_t adxrs290_process_index = 0;
uint8_t adxrs290_do_process = 0;
    
    
// Highpass filter (0.5 Hz) for LPF(RECT(HPF())) procedure
arm_fir_instance_f32 quasistatic_hpf;
float quasistatic_hpf_state[QUASISTATIC_HPF_SIZE];
float quasistatic_hpf_coeffs[QUASISTATIC_HPF_SIZE] = {0.0247798155443736, 0.00246303503022897, 0.00253345347016674, 0.00257437613725949, 0.00257357043447441, 0.00253714875975709, 0.00245154049096851, 0.00232933604789901, 0.00214507360155305, 0.00192425700777948, 0.00164306449661692, 0.00131433242153668, 0.000923202331685213, 0.000484988146832740, -1.35455571876658e-05, -0.000560989087145001, -0.00116743071503649, -0.00182184456998998, -0.00253364412939233, -0.00329031509165371, -0.00410153305991750, -0.00495139487897604, -0.00585203504186616, -0.00678548909884829, -0.00776460796289828, -0.00875930813428087, -0.00979019468104306, -0.0108224727666211, -0.0118813182110834, -0.0129362519655378, -0.0140389812629215, -0.0151256013344157, -0.0161523511857536, -0.0172278363139448, -0.0182495024007053, -0.0192628384227021, -0.0202302268370906, -0.0211738886522420, -0.0220633618241407, -0.0229015112237030, -0.0237015871785507, -0.0244305879012571, -0.0250980134058539, -0.0256930444367866, -0.0262233018954998, -0.0266747145841390, -0.0270509488837275, -0.0273440593998965, -0.0275547132895559, -0.0276798119221794, 0.972277901333446, -0.0276798119221794, -0.0275547132895559, -0.0273440593998965, -0.0270509488837275, -0.0266747145841390, -0.0262233018954998, -0.0256930444367866, -0.0250980134058539, -0.0244305879012571, -0.0237015871785507, -0.0229015112237030, -0.0220633618241407, -0.0211738886522420, -0.0202302268370906, -0.0192628384227021, -0.0182495024007053, -0.0172278363139448, -0.0161523511857536, -0.0151256013344157, -0.0140389812629215, -0.0129362519655378, -0.0118813182110834, -0.0108224727666211, -0.00979019468104306, -0.00875930813428087, -0.00776460796289828, -0.00678548909884829, -0.00585203504186616, -0.00495139487897604, -0.00410153305991750, -0.00329031509165371, -0.00253364412939233, -0.00182184456998998, -0.00116743071503649, -0.000560989087145001, -1.35455571876658e-05, 0.000484988146832740, 0.000923202331685213, 0.00131433242153668, 0.00164306449661692, 0.00192425700777948, 0.00214507360155305, 0.00232933604789901, 0.00245154049096851, 0.00253714875975709, 0.00257357043447441, 0.00257437613725949, 0.00253345347016674, 0.00246303503022897, 0.0247798155443736};
float accel_modulo_history[2*QUASISTATIC_HPF_SIZE];
uint8_t accel_modulo_history_index = 0;
    
    
// Lowpass filter (0.5 Hz) for LPF(RECT(HPF())) procedure
arm_fir_instance_f32 quasistatic_lpf;
float quasistatic_lpf_state[QUASISTATIC_LPF_SIZE];
float quasistatic_lpf_coeffs[QUASISTATIC_LPF_SIZE] = {-0.00533800718121793, -0.000796685717950488, -0.000839057035355221, -0.000869148074313502, -0.000888318471546362, -0.000892711449727314, -0.000884128406912037, -0.000858221183572695, -0.000816025355454883, -0.000751944333742036, -0.000666775295678069, -0.000553953938246114, -0.000417545060174055, -0.000254291477975769, -7.53447823642834e-05, 0.000149324632127968, 0.000394908912662689, 0.000670478797555543, 0.000979618529358667, 0.00131921433326941, 0.00169165295401155, 0.00209537990557937, 0.00253096411955006, 0.00299755340869338, 0.00349510416643541, 0.00402404752438833, 0.00458268182758997, 0.00516953450585182, 0.00578092107106754, 0.00642118432247029, 0.00708297158675375, 0.00776487745869706, 0.00846676167665852, 0.00918390591131554, 0.00991520865361832, 0.0106566667235454, 0.0114060757340068, 0.0121593166721352, 0.0129135275504850, 0.0136656454421422, 0.0144121888901453, 0.0151491038427033, 0.0158725023024348, 0.0165809206204079, 0.0172691385166111, 0.0179334890110913, 0.0185717962537384, 0.0191796180447746, 0.0197544559055959, 0.0202927436588167, 0.0207923975237108, 0.0212499154003088, 0.0216631061486893, 0.0220300175406272, 0.0223486420597360, 0.0226166954644638, 0.0228325480646112, 0.0229960026576182, 0.0231053443510011, 0.0231600167867518, 0.0231600167867518, 0.0231053443510011, 0.0229960026576182, 0.0228325480646112, 0.0226166954644638, 0.0223486420597360, 0.0220300175406272, 0.0216631061486893, 0.0212499154003088, 0.0207923975237108, 0.0202927436588167, 0.0197544559055959, 0.0191796180447746, 0.0185717962537384, 0.0179334890110913, 0.0172691385166111, 0.0165809206204079, 0.0158725023024348, 0.0151491038427033, 0.0144121888901453, 0.0136656454421422, 0.0129135275504850, 0.0121593166721352, 0.0114060757340068, 0.0106566667235454, 0.00991520865361832, 0.00918390591131554, 0.00846676167665852, 0.00776487745869706, 0.00708297158675375, 0.00642118432247029, 0.00578092107106754, 0.00516953450585182, 0.00458268182758997, 0.00402404752438833, 0.00349510416643541, 0.00299755340869338, 0.00253096411955006, 0.00209537990557937, 0.00169165295401155, 0.00131921433326941, 0.000979618529358667, 0.000670478797555543, 0.000394908912662689, 0.000149324632127968, -7.53447823642834e-05, -0.000254291477975769, -0.000417545060174055, -0.000553953938246114, -0.000666775295678069, -0.000751944333742036, -0.000816025355454883, -0.000858221183572695, -0.000884128406912037, -0.000892711449727314, -0.000888318471546362, -0.000869148074313502, -0.000839057035355221, -0.000796685717950488, -0.00533800718121793};
float accel_modulo_highpassed_history[2*QUASISTATIC_LPF_SIZE];
uint8_t accel_modulo_highpassed_history_index = 0;